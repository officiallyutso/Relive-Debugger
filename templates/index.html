<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ReLive Debugger</title>
    <link rel="stylesheet" href="../static/css/main.css">
</head>
<body>
    <h1>ReLive Debugger</h1>
    <form id="file-form" enctype="multipart/form-data">
        <label for="file">Upload a Python file to debug:</label>
        <input type="file" name="file" id="file" accept=".py" required>
        <button type="submit">Upload and Debug</button>
    </form>

    <h2>Snapshots:</h2>
    <div id="snapshot-buttons">
        <!-- Snapshot buttons will be dynamically updated here -->
        {% for snapshot in snapshots %}
            <button onclick="loadSnapshot({{ loop.index0 }})">Load Snapshot {{ loop.index0 }}</button>
        {% else %}
            <p id="no-snapshots-msg">No snapshots available</p> <!-- Display a message if no snapshots are available -->
        {% endfor %}
    </div>

    <div id="snapshot-display"></div>

    <script>
        // Function to handle file upload and start debugging
        document.getElementById("file-form").addEventListener("submit", function(event) {
            event.preventDefault();
            let formData = new FormData();
            formData.append("file", document.getElementById("file").files[0]);

            fetch("/debug_file", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    updateSnapshotButtons(data.snapshots);
                }
            })
            .catch(error => console.error("Error:", error));
        });

        // Function to dynamically update the snapshot buttons
        function updateSnapshotButtons(snapshots) {
            const container = document.getElementById("snapshot-buttons");
            container.innerHTML = ""; // Clear existing content

            if (snapshots.length === 0) {
                container.innerHTML = "<p>No snapshots available</p>";
            } else {
                snapshots.forEach((_, index) => {
                    const button = document.createElement("button");
                    button.textContent = `Load Snapshot ${index}`;
                    button.onclick = () => loadSnapshot(index);
                    container.appendChild(button);
                });
            }
        }

        // Function to load a snapshot
        function loadSnapshot(index) {
            console.log("Requesting snapshot index:", index); // Debugging log
        
            fetch("/load_snapshot", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ index: index }),
            })
            .then(response => {
                console.log("Response status:", response.status); // Debugging log
                return response.json();
            })
            .then(data => {
                console.log("Received data:", data); // Debugging log
                const display = document.getElementById("snapshot-display");
                if (data.status === "success") {
                    const snapshot = data.snapshot;
                    display.innerHTML = `
                        <p><strong>File to be debugged:</strong> ${snapshot.filename}</p>
                        <p><strong>Breakpoint:</strong> ${snapshot.line_number}</p>
                        <p><strong>Variables:</strong> ${JSON.stringify(snapshot.local_variables)}</p>
                    `;
                } else {
                    display.innerHTML = `<p style="color: red;">${data.message}</p>`;
                }
            })
            .catch(error => {
                console.error("Error loading snapshot:", error);
                document.getElementById("snapshot-display").innerHTML =
                    "<p style='color: red;'>Failed to load snapshot. Please try again.</p>";
            });
        }
        
    </script>

</body>
</html>
